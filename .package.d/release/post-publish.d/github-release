#!/bin/bash
##
## Post-publish hook: build musl binary and create GitHub release
##

set -e

VERSION=$(git describe --tags --exact-match 2>/dev/null) || {
    echo "Warning: not on a tag, skipping GitHub release" >&2
    exit 0
}

echo "=== Building static musl binary ===" >&2

./musl-build

BINARY="target/alpine-musl/release/shyaml-rs"
if [ ! -f "$BINARY" ]; then
    echo "Error: musl binary not found at $BINARY" >&2
    exit 1
fi

ARTIFACT="shyaml-rs-${VERSION}-x86_64-linux-musl"
cp "$BINARY" "$ARTIFACT"
gzip -f "$ARTIFACT"
ARTIFACT="${ARTIFACT}.gz"

echo "Built: $ARTIFACT ($(du -h "$ARTIFACT" | cut -f1))" >&2

echo "=== Generating changelog ===" >&2

PREV_TAG=$(git tag --sort=-version:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | grep -A1 "^${VERSION}$" | tail -1)

if [ "$PREV_TAG" = "$VERSION" ] || [ -z "$PREV_TAG" ]; then
    CHANGELOG=$(gitchangelog 2>/dev/null | tail -n +2 || echo "Initial release")
else
    CHANGELOG=$(gitchangelog "$PREV_TAG".."$VERSION" 2>/dev/null | tail -n +2 || echo "See commit history")
fi

echo "=== Creating GitHub release ===" >&2

gh release create "$VERSION" \
    --title "Release $VERSION" \
    --notes "$CHANGELOG" \
    "$ARTIFACT"

rm -f "$ARTIFACT"

echo "GitHub release created: $(gh release view "$VERSION" --json url -q .url)" >&2
