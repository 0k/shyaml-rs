#!/bin/bash

set -e

if grep -q '%%version%%' Cargo.toml 2>/dev/null; then
    echo "Error: Cargo.toml contains %%version%% placeholder." >&2
    echo "Run ./autogen.sh first to substitute the version." >&2
    exit 1
fi

IMAGE_NAME="shyaml-musl-builder"

docker build -t "$IMAGE_NAME" - <<'DOCKERFILE'
FROM alpine:3.19

RUN apk add musl-dev openssl-dev clang-dev rust cargo

RUN addgroup -g 1000 rust && \
    adduser -D -u 1000 -G rust rust

USER rust
WORKDIR /home/rust/rs
DOCKERFILE

docker run --rm -v "$PWD:/home/rust/rs" \
       "$IMAGE_NAME" \
       cargo build --release --target-dir target/alpine-musl/
